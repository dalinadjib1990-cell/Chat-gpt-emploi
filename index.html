<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI Dali Emploi CEM â€” Ù…ÙˆÙ„Ø¯ Ø°ÙƒÙŠ + GA + ØªØµØ¯ÙŠØ±</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<style>
:root{
  --bg:#071022; --card:#07182a; --muted:#9fb7d9; --accent:#06b6d4;
  --yellow:#fde68a; --green:#86efac; --regular:#7dd3fc; --text:#e6eef6;
}
body{margin:0;background:linear-gradient(180deg,var(--bg),#031226);color:var(--text);font-family:Arial,Helvetica,sans-serif}
.wrap{max-width:1200px;margin:18px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between}
h1{margin:0;color:#ffd873;font-size:20px}
.card{background:var(--card);padding:12px;border-radius:10px;margin-top:12px;box-shadow:0 6px 20px rgba(2,6,23,.6)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
label.small{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
input[type=number],input[type=text],select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
button.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#022c3a}
.btn-accent{background:#ffd873;color:#000}
.btn-danger{background:#ff6b6b;color:#111}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid rgba(255,255,255,0.06);padding:6px;text-align:center;font-size:13px}
th{background:#0b2740;color:var(--accent)}
.muted{color:var(--muted);font-size:13px}
.legend{display:flex;gap:12px;align-items:center;margin-top:8px}
.key{width:18px;height:18px;border-radius:4px;border:1px solid rgba(0,0,0,.15)}
.slot-split{background:var(--yellow);color:#111;font-weight:700}
.slot-prac{background:var(--green);color:#04200b;font-weight:700}
.slot-regular{background:var(--regular);color:#022c3a;font-weight:700}
.editable{min-height:20px;outline:none}
.note{color:#bcd;font-size:13px}
.small{font-size:13px}
.progressbar{height:8px;background:#0b1220;border-radius:6px;overflow:hidden;margin-top:8px}
.progress{height:100%;background:linear-gradient(90deg,#06b6d4,#7c3aed);width:0%}
@media(max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>AI Dali Emploi CEM â€” Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø±</h1>
      <div class="muted small">Ø§Ù„Ù…Ø´Ø±Ù: <strong>Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨</strong></div>
    </div>
    <div>
      <div class="muted small">Ø­Ø§Ù„Ø©: <span id="status">Ø¬Ø§Ù‡Ø²</span></div>
    </div>
  </header>

  <!-- INPUTS -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label class="small">Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</label>
        <div style="display:flex;gap:8px">
          <input id="lvl1" type="number" value="5" min="0" />
          <input id="lvl2" type="number" value="4" min="0" />
          <input id="lvl3" type="number" value="3" min="0" />
          <input id="lvl4" type="number" value="2" min="0" />
        </div>
        <div class="note" style="margin-top:8px">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: <span id="totalSections">14</span></div>
      </div>

      <div class="col">
        <label class="small">Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-accent" onclick="fillMySchool()">ğŸ« Ù…Ø¤Ø³Ø³ØªÙŠ</button>
          <button class="btn btn-primary" id="btnGenerate" onclick="generate(false)">âš¡ ØªÙˆÙ„ÙŠØ¯</button>
          <button class="btn" onclick="generate(true)">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ (ØªØºÙŠÙ‘Ø±)</button>
          <button class="btn" onclick="runGA()">ğŸ§¬ ØªØ´ØºÙŠÙ„ GA (ØªØ­Ø³ÙŠÙ†)</button>
          <button class="btn btn-danger" onclick="resetForManual()">ğŸ§¾ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
          <button class="btn" onclick="downloadPDF()">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ PDF</button>
          <button class="btn" onclick="downloadWord()">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ Word</button>
        </div>

        <div class="progressbar"><div id="progress" class="progress"></div></div>
        <div id="gaStatus" class="note"></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="muted small">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†)</div>
      <table id="teachersTable">
        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³Ù†Ø¯Ø©</th><th>Ù†ØµØ§Ø¨ (Ø³Ø§/Ø£Ø³Ø¨ÙˆØ¹)</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px">
        <button class="btn" onclick="addEmptyTeacher()">Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯</button>
      </div>

      <div class="legend">
        <div><div class="key" style="background:var(--yellow)"></div><div class="small">Ø£Ø¹Ù…Ø§Ù„ Ù…ÙˆØ¬Ù‡Ø© (ØªÙÙˆÙŠØ¬)</div></div>
        <div><div class="key" style="background:var(--green)"></div><div class="small">Ø£Ø¹Ù…Ø§Ù„ ØªØ·Ø¨ÙŠÙ‚ÙŠØ©</div></div>
        <div><div class="key" style="background:var(--regular)"></div><div class="small">Ø­ØµØ© Ù…Ù†ØªØ¸Ù…Ø©</div></div>
      </div>
    </div>
  </div>

  <!-- OUTPUTS -->
  <div id="output" class="card">
    <h3 style="margin:0">Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª â€” Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h3>
    <div id="diagnostic" class="note" style="margin-top:6px">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯.</div>
    <div id="schoolTable" style="margin-top:12px;overflow:auto"></div>
    <div id="teachersView" style="margin-top:12px"></div>
    <div id="studentsView" style="margin-top:12px"></div>
  </div>
</div>

<!-- libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =======================
   Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¬Ø¹ÙŠØ©
   ======================= */
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const SLOTS = ['08:00-09:00','09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00'];
const SUBJECT_COLOR = {
  'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':'#ffd6d6','Ø¹Ø±Ø¨ÙŠØ©':'#d6f0ff','ÙØ±Ù†Ø³ÙŠØ©':'#ffe6cc','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':'#e6ffec',
  'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':'#eefecc','ÙÙŠØ²ÙŠØ§Ø¡':'#ccf7ff','ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':'#f0dcff',
  'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':'#fff0cc','ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':'#fff7d6','Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':'#e8fffe','ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§':'#e6f7ff',
  'Ø±Ø³Ù…':'#f5e6ff','Ù…ÙˆØ³ÙŠÙ‚Ù‰':'#f0ffe6','Ø±ÙŠØ§Ø¶Ø©':'#e6f2ff'
};
// Ø³Ø§Ø¹Ø§Øª Ø±Ø³Ù…ÙŠØ© Ù…Ø¨Ø³Ø·Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)
const HOURS = {
  '1': {'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':5,'Ø¹Ø±Ø¨ÙŠØ©':5,'ÙØ±Ù†Ø³ÙŠØ©':3,'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':2,'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':2,'ÙÙŠØ²ÙŠØ§Ø¡':2,'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':2,'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':1,'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':1,'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':2,'Ø±Ø³Ù…':0,'Ù…ÙˆØ³ÙŠÙ‚Ù‰':0,'Ø±ÙŠØ§Ø¶Ø©':2},
  '2': {'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':5,'Ø¹Ø±Ø¨ÙŠØ©':5,'ÙØ±Ù†Ø³ÙŠØ©':4,'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':3,'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':2,'ÙÙŠØ²ÙŠØ§Ø¡':2,'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':2,'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':1,'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':1,'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':2,'Ø±Ø³Ù…':0,'Ù…ÙˆØ³ÙŠÙ‚Ù‰':0,'Ø±ÙŠØ§Ø¶Ø©':2},
  '3': {'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':5,'Ø¹Ø±Ø¨ÙŠØ©':5,'ÙØ±Ù†Ø³ÙŠØ©':3,'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':3,'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':2,'ÙÙŠØ²ÙŠØ§Ø¡':2,'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':2,'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':1,'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':1,'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':2,'Ø±Ø³Ù…':0,'Ù…ÙˆØ³ÙŠÙ‚Ù‰':0,'Ø±ÙŠØ§Ø¶Ø©':2},
  '4': {'Ø±ÙŠØ§Ø¶ÙŠØ§Øª':6,'Ø¹Ø±Ø¨ÙŠØ©':6,'ÙØ±Ù†Ø³ÙŠØ©':4,'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©':3,'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©':2,'ÙÙŠØ²ÙŠØ§Ø¡':2,'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§':2,'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©':0,'ØªØ±Ø¨ÙŠØ© Ù…Ø¯Ù†ÙŠØ©':0,'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ':0,'Ø±Ø³Ù…':2,'Ù…ÙˆØ³ÙŠÙ‚Ù‰':2,'Ø±ÙŠØ§Ø¶Ø©':2}
};

/* =======================
   Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
   ======================= */
let state = {
  institution: 'Ù…Ø´Ù†ØªÙ„ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·Ø§Ù‡Ø±',
  principal: 'Ø¯Ø§Ù„ÙŠ Ù†Ø¬ÙŠØ¨',
  sections: [],   // e.g. ['1Ù…1', '1Ù…2', ...]
  teachers: [],   // {name, subject, sections:[], targetHours}
};

let lastSchedule = null;

/* ---------- DOM helpers ---------- */
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.from(document.querySelectorAll(s)); }

/* ---------- sections build ---------- */
function buildSections(){
  const l1 = parseInt($('#lvl1').value||0), l2 = parseInt($('#lvl2').value||0), l3 = parseInt($('#lvl3').value||0), l4 = parseInt($('#lvl4').value||0);
  const secs = [];
  for(let i=1;i<=l1;i++) secs.push(`1Ù…${i}`);
  for(let i=1;i<=l2;i++) secs.push(`2Ù…${i}`);
  for(let i=1;i<=l3;i++) secs.push(`3Ù…${i}`);
  for(let i=1;i<=l4;i++) secs.push(`4Ù…${i}`);
  state.sections = secs;
  $('#totalSections').innerText = secs.length;
  return secs;
}
$all('#lvl1,#lvl2,#lvl3,#lvl4').forEach(el=>el.addEventListener('change', buildSections));
buildSections();

/* ---------- utilities ---------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function clone(x){ return JSON.parse(JSON.stringify(x)); }

/* =======================
   Ø²Ø± "Ù…Ø¤Ø³Ø³ØªÙŠ" â€” ØªØ¹Ø¨Ø¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
   ======================= */
function fillMySchool(){
  buildSections();
  const teachers = [];
  // Ø±ÙŠØ§Ø¶ÙŠØ§Øª 4
  for(let i=1;i<=4;i++) teachers.push({name:`Ø£. Ø±ÙŠØ§Ø¶ÙŠØ§Øª ${i}`, subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', sections:[], targetHours:0});
  // Ø¹Ø±Ø¨ÙŠØ© 1
  teachers.push({name:'Ø£. Ø¹Ø±Ø¨ÙŠØ©', subject:'Ø¹Ø±Ø¨ÙŠØ©', sections:[], targetHours:0});
  // ÙØ±Ù†Ø³ÙŠØ© 3
  for(let i=1;i<=3;i++) teachers.push({name:`Ø£. ÙØ±Ù†Ø³ÙŠØ© ${i}`, subject:'ÙØ±Ù†Ø³ÙŠØ©', sections:[], targetHours:0});
  // Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© 3
  for(let i=1;i<=3;i++) teachers.push({name:`Ø£. Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ${i}`, subject:'Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', sections:[], targetHours:0});
  // Ø¹Ù„ÙˆÙ… 2
  for(let i=1;i<=2;i++) teachers.push({name:`Ø£. Ø¹Ù„ÙˆÙ… ${i}`, subject:'Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ©', sections:[], targetHours:0});
  // ÙÙŠØ²ÙŠØ§Ø¡ 2
  for(let i=1;i<=2;i++) teachers.push({name:`Ø£. ÙÙŠØ²ÙŠØ§Ø¡ ${i}`, subject:'ÙÙŠØ²ÙŠØ§Ø¡', sections:[], targetHours:0});
  // Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª 2 (ØªØ§Ø±ÙŠØ®+Ù…Ø¯Ù†ÙŠØ©)
  for(let i=1;i<=2;i++) teachers.push({name:`Ø£. Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª ${i}`, subject:'ØªØ§Ø±ÙŠØ® ÙˆØ¬ØºØ±Ø§ÙÙŠØ§', sections:[], targetHours:0});
  // ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ© 1
  teachers.push({name:'Ø£. ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©', subject:'ØªØ±Ø¨ÙŠØ© Ø§Ø³Ù„Ø§Ù…ÙŠØ©', sections:[], targetHours:0});
  // Ø§Ø¹Ù„Ø§Ù… Ø§Ù„ÙŠ 1 (1-3Ù…)
  teachers.push({name:'Ø£. Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ', subject:'Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ', sections:[], targetHours:0});
  // ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ 1
  teachers.push({name:'Ø£. ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', subject:'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', sections:[], targetHours:0});
  // ØªØ±Ø¨ÙŠØ© Ø¨Ø¯Ù†ÙŠØ© 2
  for(let i=1;i<=2;i++) teachers.push({name:`Ø£. Ø¨Ø¯Ù†ÙŠØ© ${i}`, subject:'Ø±ÙŠØ§Ø¶Ø©', sections:[], targetHours:0});
  // ÙÙ†ÙˆÙ† 1 (Ø³Ù†Ø©4)
  teachers.push({name:'Ø£. ÙÙ†ÙˆÙ†', subject:'Ø±Ø³Ù…', sections:[], targetHours:0});

  // map sections needed per subject (respecting Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ only 1-3, Ø±Ø³Ù… only 4)
  const sectionsByMat = {};
  state.sections.forEach(sec=>{
    const lvl = sec.charAt(0);
    const hmap = HOURS[lvl];
    for(const mat in hmap){
      if(hmap[mat] > 0){
        if(mat==='Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ' && lvl==='4') continue;
        if((mat==='Ø±Ø³Ù…' || mat==='Ù…ÙˆØ³ÙŠÙ‚Ù‰') && lvl!=='4') continue;
        sectionsByMat[mat] = sectionsByMat[mat] || [];
        sectionsByMat[mat].push(sec);
      }
    }
  });

  // group teachers by subject
  const bySubj = {};
  teachers.forEach(t=> { bySubj[t.subject]=bySubj[t.subject]||[]; bySubj[t.subject].push(t); });

  // distribute sections round-robin among teachers of that subject
  for(const mat in sectionsByMat){
    const secs = sectionsByMat[mat];
    const tlist = bySubj[mat] || [];
    if(tlist.length===0) continue;
    let i=0;
    secs.forEach(s=> { tlist[i%tlist.length].sections.push(s); i++; });
  }

  // compute target hours
  teachers.forEach(t=>{
    let h=0;
    t.sections.forEach(s=>{
      const lvl = s.charAt(0);
      h += HOURS[lvl][t.subject] || 0;
    });
    t.targetHours = h;
  });

  // ensure length 27
  while(teachers.length<27) teachers.push({name:`Ø£. Ø¥Ø¶Ø§ÙÙŠ ${teachers.length+1}`, subject:'Ø±ÙŠØ§Ø¶Ø©', sections:[], targetHours:0});

  state.teachers = teachers;
  renderTeachersTable();
  $('#status').innerText = 'ØªÙ… Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ø³Ø³ØªÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹';
  generate(false);
}

/* ---------- render/modify teachers table ---------- */
function renderTeachersTable(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML='';
  state.teachers.forEach((t,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td contenteditable="true" onblur="syncTeachersFromDOM()">${t.name}</td>
                    <td contenteditable="true" onblur="syncTeachersFromDOM()">${t.subject}</td>
                    <td contenteditable="true" onblur="syncTeachersFromDOM()">${(t.sections||[]).join(',')}</td>
                    <td contenteditable="true" onblur="syncTeachersFromDOM()">${t.targetHours||0}</td>
                    <td><button onclick="deleteTeacher(${idx})">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
}
function addEmptyTeacher(){ state.teachers.push({name:'Ø£Ø³ØªØ§Ø° Ø¬Ø¯ÙŠØ¯',subject:'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',sections:[],targetHours:0}); renderTeachersTable();}
function deleteTeacher(i){ state.teachers.splice(i,1); renderTeachersTable(); }
function syncTeachersFromDOM(){
  const rows = $all('#teachersTable tbody tr');
  const arr = [];
  rows.forEach(r=>{
    const c = r.querySelectorAll('td');
    if(!c[0]) return;
    const name = c[0].innerText.trim();
    const subj = c[1].innerText.trim();
    const secs = c[2].innerText.split(',').map(s=>s.trim()).filter(Boolean);
    const target = parseInt(c[3].innerText.trim()) || 0;
    arr.push({name,subject:subj,sections:secs,targetHours:target});
  });
  if(arr.length>0) state.teachers = arr;
}

/* =======================
   Heuristic generator (fast) + GA (improvement)
   ======================= */

/* helper: create empty schedule structure */
function emptySchedule(){
  const sched = {};
  state.sections.forEach(sec=>{
    sched[sec] = {};
    DAYS.forEach(d=> sched[sec][d] = Array(SLOTS.length).fill(null));
  });
  return sched;
}

/* build tasks per section (subject->count) */
function buildTasksForSections(){
  const tasks = {};
  state.sections.forEach(sec=>{
    const lvl = sec.charAt(0);
    tasks[sec] = {};
    const map = HOURS[lvl];
    for(const mat in map){
      const h = map[mat]||0;
      if(h>0) tasks[sec][mat] = h;
    }
    // ensure for lvl4: remove Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ
    if(lvl==='4'){ delete tasks[sec]['Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ']; if(!tasks[sec]['Ø±Ø³Ù…']) tasks[sec]['Ø±Ø³Ù…']=2; }
  });
  return tasks;
}

/* fitness function: higher is better */
function fitnessOf(schedule){
  // penalties: teacher double-booking, missing hours vs required, teacher overload (>targetHours), single evening slot for teacher, pedagogical day violation (core on Thursday)
  const teacherBusy = {}; // teacher->day#slot count
  const teacherHours = {}; // teacher->count
  const placedCount = 0;
  // build teacher list
  state.teachers.forEach(t=>{ teacherBusy[t.name] = {}; teacherHours[t.name]=0; DAYS.forEach(d=>{ for(let s=0;s<SLOTS.length;s++) teacherBusy[t.name][d+'#'+s]=0; }); });
  // compute required tasks
  const required = {}; // key sec||mat -> hours
  const tasks = buildTasksForSections();
  for(const sec in tasks){ for(const mat in tasks[sec]) required[sec+'||'+mat]=tasks[sec][mat]; }
  let placed = {}; // key->count
  // iterate schedule
  let conflicts=0;
  for(const sec of state.sections){
    for(const d of DAYS){
      for(let s=0;s<SLOTS.length;s++){
        const c = schedule[sec][d][s];
        if(!c) continue;
        const tname = c.teacher || 'â€”';
        if(teacherBusy[tname]) teacherBusy[tname][d+'#'+s] = (teacherBusy[tname][d+'#'+s]||0)+1;
        if(teacherBusy[tname][d+'#'+s] > 1) conflicts += (teacherBusy[tname][d+'#'+s]-1);
        teacherHours[tname] = (teacherHours[tname]||0) + 1;
        const key = sec+'||'+c.subject;
        placed[key] = (placed[key]||0) + 1;
        // pedagogical: avoid core on Thursday
        if(d==='Ø§Ù„Ø®Ù…ÙŠØ³' && ['Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø¹Ø±Ø¨ÙŠØ©','ÙØ±Ù†Ø³ÙŠØ©','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'].includes(c.subject)) conflicts += 2;
      }
    }
  }
  // missing tasks penalty
  let missingPenalty=0;
  for(const key in required){
    const need = required[key], got = placed[key]||0;
    if(got < need) missingPenalty += (need-got)*30;
  }
  // teacher overload penalty
  let overPenalty = 0;
  for(const t of state.teachers){
    const h = teacherHours[t.name] || 0;
    if(h > 20) overPenalty += (h-20)*50;
    if(t.targetHours && h > t.targetHours) overPenalty += (h - t.targetHours)*6;
  }
  // single evening penalty
  let singleEven = 0;
  for(const t of state.teachers){
    let ev = 0;
    for(const d of DAYS) for(let s=4;s<SLOTS.length;s++){
      const key = d+'#'+s;
      if(teacherBusy[t.name] && teacherBusy[t.name][key]) ev += teacherBusy[t.name][key];
    }
    if(ev===1) singleEven += 30;
  }
  const conflictPenalty = conflicts * 20;
  const score = 1000 - (missingPenalty + overPenalty + conflictPenalty + singleEven);
  return score;
}

/* initialize population: create many random schedules by shuffling placements */
function initPopulation(popSize){
  const pop = [];
  for(let i=0;i<popSize;i++){
    const sched = emptySchedule();
    const tasks = buildTasksForSections();
    // for each section, create list of subject occurrences
    for(const sec of state.sections){
      const list = [];
      const lvl = sec.charAt(0);
      for(const subj in tasks[sec]){
        for(let k=0;k<tasks[sec][subj];k++) list.push(subj);
      }
      // shuffle subjects and fill into slots randomly preferring morning
      shuffle(list);
      const slots = [];
      for(const d of DAYS) for(let s=0;s<SLOTS.length;s++) slots.push([d,s]);
      // prefer morning order: sort slots by s<4 then day order
      slots.sort((a,b)=> (a[1] < 4 ? 0 : 1) - (b[1] < 4 ? 0 : 1));
      let idx=0;
      for(const subj of list){
        // find next free slot
        while(idx < slots.length && sched[sec][slots[idx][0]][slots[idx][1]]) idx++;
        if(idx >= slots.length) break;
        const [d,s] = slots[idx];
        sched[sec][d][s] = {subject:subj, teacher:null, type:'regular'};
        idx++;
      }
      // fill empties with any available subject (e.g., sport)
      for(const d of DAYS) for(let s=0;s<SLOTS.length;s++) if(!sched[sec][d][s]) sched[sec][d][s] = {subject:'Ø±ÙŠØ§Ø¶Ø©', teacher:null, type:'regular'};
    }
    // assign teachers greedily
    // build teacher objects
    const tObjs = state.teachers.map(t=>({...t, busy:{}, load:0}));
    function assignTeacherToCell(sec, subj, day, sIdx){
      // prefer teacher who has sec in their sections
      let candidates = tObjs.filter(t=>t.subject===subj);
      candidates.sort((a,b)=>{
        const aHas=a.sections.includes(sec)?0:1; const bHas=b.sections.includes(sec)?0:1;
        if(aHas!==bHas) return aHas-bHas;
        return a.load - b.load;
      });
      for(const c of candidates){
        const key = day+'#'+sIdx;
        if(c.busy[key]) continue;
        c.busy[key]=true; c.load++; return c.name;
      }
      // fallback: any teacher of subj
      if(candidates.length) return candidates[0].name;
      return 'â€”';
    }
    for(const sec of state.sections) for(const d of DAYS) for(let s=0;s<SLOTS.length;s++){
      const cell = sched[sec][d][s];
      if(cell) cell.teacher = assignTeacherToCell(sec, cell.subject, d, s);
    }
    pop.push(sched);
  }
  return pop;
}

/* GA main */
async function runGA(popSize=50, generations=120){
  $('#progress').style.width='0%';
  $('#gaStatus').innerText = `GA: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ§Ù† (${popSize})...`;
  let pop = initPopulation(popSize);
  let best = null, bestScore = -Infinity;
  for(let gen=0; gen<generations; gen++){
    // evaluate
    const scores = pop.map(p=> ({p, score: fitnessOf(p)}));
    scores.sort((a,b)=>b.score - a.score);
    if(scores[0].score > bestScore){ best = clone(scores[0].p); bestScore = scores[0].score; }
    // reporting
    if(gen%5===0) { $('#gaStatus').innerText = `GA: Ø¬ÙŠÙ„ ${gen+1}/${generations} â€” Ø£ÙØ¶Ù„: ${Math.round(bestScore)}`; $('#progress').style.width = `${Math.round((gen/generations)*100)}%`; await new Promise(r=>setTimeout(r,10)); }
    // selection (elitism + tournament)
    const newPop = [];
    // keep top 2
    newPop.push(clone(scores[0].p)); if(scores[1]) newPop.push(clone(scores[1].p));
    // fill rest
    while(newPop.length < popSize){
      // tournament
      function tournament(){ const a=pop[Math.floor(Math.random()*pop.length)]; const b=pop[Math.floor(Math.random()*pop.length)]; return fitnessOf(a) > fitnessOf(b) ? a : b; }
      const parentA = clone(tournament()), parentB = clone(tournament());
      // crossover: swap assignments for random subset of sections
      const child = clone(parentA);
      const cut = Math.floor(Math.random()*state.sections.length);
      const secs = state.sections.slice(0,cut);
      for(const s of secs){
        child[s] = clone(parentB[s]);
      }
      // mutation: swap two random slots in random section
      if(Math.random() < 0.15){
        const s = state.sections[Math.floor(Math.random()*state.sections.length)];
        const d1 = DAYS[Math.floor(Math.random()*DAYS.length)], d2 = DAYS[Math.floor(Math.random()*DAYS.length)];
        const si = Math.floor(Math.random()*SLOTS.length), sj = Math.floor(Math.random()*SLOTS.length);
        const tmp = child[s][d1][si]; child[s][d1][si] = child[s][d2][sj]; child[s][d2][sj] = tmp;
      }
      newPop.push(child);
    }
    pop = newPop;
  }
  $('#progress').style.width='100%';
  $('#gaStatus').innerText = `GA Ø§Ù†ØªÙ‡Ù‰ â€” Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©: ${Math.round(bestScore)} â€” Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©`;
  return best;
}

/* runGA wrapper */
async function runGA(){
  $('#status').innerText = 'GA ÙŠØ¹Ù…Ù„...';
  const best = await runGA(60, 150); // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ù‡Ù†Ø§
  lastSchedule = best;
  renderAll(best);
  $('#status').innerText = 'GA Ø§Ù†ØªÙ‡Ù‰ â€” Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø­Ù„';
}

/* generate (heuristic) â€” parameter regen randomize=true to shuffle more */
function generate(randomize=false){
  syncTeachersFromDOM();
  buildSections();
  // simple heuristic schedule
  const sched = emptySchedule();
  const tasks = buildTasksForSections();

  // for each section, create ordered subject list (priority core)
  for(const sec of state.sections){
    const list = [];
    for(const subj in tasks[sec]){
      for(let h=0; h<tasks[sec][subj]; h++) list.push(subj);
    }
    if(randomize) shuffle(list);
    // fill slots preferring morning
    const slots = [];
    for(const d of DAYS) for(let s=0;s<SLOTS.length;s++) slots.push([d,s]);
    slots.sort((a,b)=> (a[1]<4?0:1)-(b[1]<4?0:1));
    let idx=0;
    for(const subj of list){
      while(idx < slots.length && sched[sec][slots[idx][0]][slots[idx][1]]) idx++;
      if(idx >= slots.length) break;
      const [d,s] = slots[idx];
      // avoid placing core on Thursday if possible
      if(d==='Ø§Ù„Ø®Ù…ÙŠØ³' && ['Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø¹Ø±Ø¨ÙŠØ©','ÙØ±Ù†Ø³ÙŠØ©','Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'].includes(subj)){
        // find next non-Thursday slot
        const p = slots.findIndex(x=> x[0] !== 'Ø§Ù„Ø®Ù…ÙŠØ³' && !sched[sec][x[0]][x[1]]);
        if(p>=0){ const [dd,ss] = slots[p]; sched[sec][dd][ss]={subject:subj,teacher:null,type:'regular'}; slots.splice(p,1); idx=0; continue; }
      }
      sched[sec][d][s] = {subject:subj,teacher:null,type:'regular'};
      idx++;
    }
    // fill empties with sport or any teacher subject
    for(const d of DAYS) for(let s=0;s<SLOTS.length;s++) if(!sched[sec][d][s]) sched[sec][d][s] = {subject:'Ø±ÙŠØ§Ø¶Ø©', teacher:null, type:'regular'};
  }

  // assign teachers greedily
  const tObjs = state.teachers.map(t=>({...t, busy:{}, load:0}));
  function findTeacher(sec, subj, day, sIdx){
    let cands = tObjs.filter(t=> t.subject===subj );
    cands.sort((a,b)=> (a.sections.includes(sec)?0:1) - (b.sections.includes(sec)?0:1) || a.load - b.load );
    for(const c of cands){
      const key = day+'#'+sIdx;
      if(c.busy[key]) continue;
      c.busy[key]=true; c.load++; return c;
    }
    // fallback: any teacher of subject
    if(cands.length) return cands[0];
    return {name:'â€”', busy:{}, load:0};
  }
  for(const sec of state.sections) for(const d of DAYS) for(let s=0;s<SLOTS.length;s++){
    const cell = sched[sec][d][s];
    if(!cell) continue;
    const t = findTeacher(sec, cell.subject, d, s);
    cell.teacher = t.name;
  }

  lastSchedule = sched;
  renderAll(sched);
  $('#status').innerText = 'ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (heuristic)';
  $('#diagnostic').innerText = `ØªÙˆÙ„ÙŠØ¯: ${state.sections.length} Ù‚Ø³Ù… â€” Ø§Ø¶ØºØ· GA Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬.`;
}

/* render outputs */
function renderAll(schedule){
  // SCHOOL table
  const schoolDiv = $('#schoolTable'); schoolDiv.innerHTML = '';
  const table = document.createElement('table');
  let head = `<tr><th>Ø§Ù„ÙˆÙ‚Øª \\ Ø§Ù„Ù‚Ø³Ù…</th>`;
  state.sections.forEach(s=> head += `<th>${s}</th>`);
  head += `</tr>`; table.innerHTML = head;
  for(const d of DAYS){
    for(let si=0; si<SLOTS.length; si++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d} â€” ${SLOTS[si]}</td>`;
      state.sections.forEach(sec=>{
        const c = schedule[sec][d][si];
        if(!c) { tr.innerHTML += `<td>â€”</td>`; return; }
        const color = SUBJECT_COLOR[c.subject] || '#7dd3fc';
        const cellHtml = `<div style="background:${color};color:#031226;padding:6px;border-radius:6px">${c.subject}<br/><small>${c.teacher||''}</small></div>`;
        tr.innerHTML += `<td>${cellHtml}</td>`;
      });
      table.appendChild(tr);
    }
  }
  schoolDiv.appendChild(table);

  // Teachers view (compact)
  const tdiv = $('#teachersView'); tdiv.innerHTML = '<h4 style="margin:6px 0">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (Ù…ÙˆØ¬Ø²)</h4>';
  state.teachers.forEach(t=>{
    const tb = document.createElement('table'); tb.style.marginBottom='8px';
    let hdr = `<tr><th colspan="${SLOTS.length+1}">${t.name} â€” ${t.subject}</th></tr>`;
    tb.innerHTML = hdr;
    const hr = document.createElement('tr'); hr.innerHTML = `<td>Ø§Ù„ÙŠÙˆÙ…\\Ø­ØµØ©</td>`; SLOTS.forEach(s=> hr.innerHTML += `<td>${s}</td>`); tb.appendChild(hr);
    for(const d of DAYS){
      const r = document.createElement('tr'); r.innerHTML = `<td>${d}</td>`;
      for(let si=0; si<SLOTS.length; si++){
        let found = '';
        for(const sec of state.sections){
          const c = schedule[sec][d][si];
          if(c && c.teacher===t.name){ found = `${sec} â€” ${c.subject}`; break; }
        }
        r.innerHTML += `<td>${found}</td>`;
      }
      tb.appendChild(r);
    }
    tdiv.appendChild(tb);
  });

  // Students view
  const sdiv = $('#studentsView'); sdiv.innerHTML = '<h4 style="margin:6px 0">Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ° (ÙƒÙ„ Ù‚Ø³Ù…)</h4>';
  state.sections.forEach(sec=>{
    const tb = document.createElement('table'); tb.style.marginBottom='8px';
    tb.innerHTML = `<tr><th colspan="${SLOTS.length+1}">${sec}</th></tr>`;
    const hr = document.createElement('tr'); hr.innerHTML = `<td>Ø§Ù„ÙŠÙˆÙ…\\Ø­ØµØ©</td>`; SLOTS.forEach(s=> hr.innerHTML += `<td>${s}</td>`); tb.appendChild(hr);
    for(const d of DAYS){
      const r = document.createElement('tr'); r.innerHTML = `<td>${d}</td>`;
      for(let si=0; si<SLOTS.length; si++){
        const c = schedule[sec][d][si];
        if(!c) r.innerHTML += `<td>â€”</td>`; else {
          const color = SUBJECT_COLOR[c.subject] || '#7dd3fc';
          r.innerHTML += `<td style="background:${color};color:#031226">${c.subject}<br/><small>${c.teacher||''}</small></td>`;
        }
      }
      tb.appendChild(r);
    }
    sdiv.appendChild(tb);
  });
}

/* ---------- GA button wrapper ---------- */
async function runGA(){
  $('#status').innerText = 'GA ÙŠØ¨Ø¯Ø£... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù';
  $('#gaStatus').innerText = 'GA: ÙŠØ¹Ù…Ù„...';
  const best = await runGA_internal(60, 120); // internal function name differs
  // runGA_internal returns schedule
  lastSchedule = best;
  renderAll(best);
  $('#status').innerText = 'GA Ø§Ù†ØªÙ‡Ù‰ â€” Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù…Ø¹Ø±ÙˆØ¶Ø©';
  $('#gaStatus').innerText = '';
}

/* to avoid name clash, map runGA_internal to runGA defined earlier */
const runGA_internal = runGA_internal_impl;
async function runGA_internal_impl(popSize, gens){
  // simply call runGA function defined earlier in this file (which we implemented above)
  // but runGA earlier is a named function; here we call the runGA defined above â€” actually we already implemented runGA(...) earlier returning best
  // to keep it consistent, call runGA() defined above (rename earlier runGA to runGA_impl)... for simplicity, reuse function runGA defined above earlier.
  // However to avoid confusion, directly call runGA_main as defined earlier:
  return await runGA_main(popSize, gens);
}

/* Implement runGA_main separately to match earlier GA code */
async function runGA_main(popSize=50, generations=120){
  $('#progress').style.width='0%';
  $('#gaStatus').innerText = `GA: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙƒØ§Ù† (${popSize})...`;
  let pop = initPopulation(popSize);
  let best = null, bestScore = -Infinity;
  for(let gen=0; gen<generations; gen++){
    const scores = pop.map(p=> ({p, score: fitnessOf(p)}));
    scores.sort((a,b)=>b.score-a.score);
    if(scores[0].score > bestScore){ best = clone(scores[0].p); bestScore = scores[0].score; }
    // progress update
    if(gen%5===0){ $('#gaStatus').innerText = `GA: Ø¬ÙŠÙ„ ${gen+1}/${generations} â€” Ø£ÙØ¶Ù„: ${Math.round(bestScore)}`; $('#progress').style.width = `${Math.round((gen/generations)*100)}%`; await new Promise(r=>setTimeout(r,10)); }
    // new population
    const newPop = [];
    // elitism
    newPop.push(clone(scores[0].p));
    if(scores[1]) newPop.push(clone(scores[1].p));
    while(newPop.length < popSize){
      // selection
      function tournament(){ const a=pop[Math.floor(Math.random()*pop.length)]; const b=pop[Math.floor(Math.random()*pop.length)]; return fitnessOf(a) > fitnessOf(b) ? a : b; }
      const parentA = clone(tournament()), parentB = clone(tournament());
      // crossover: swap random set of sections
      const child = clone(parentA);
      const cut = Math.floor(Math.random()*state.sections.length);
      const secs = state.sections.slice(0,cut);
      for(const s of secs) child[s] = clone(parentB[s]);
      // mutation
      if(Math.random() < 0.12){
        const s = state.sections[Math.floor(Math.random()*state.sections.length)];
        const d1 = DAYS[Math.floor(Math.random()*DAYS.length)], d2 = DAYS[Math.floor(Math.random()*DAYS.length)];
        const si = Math.floor(Math.random()*SLOTS.length), sj = Math.floor(Math.random()*SLOTS.length);
        const tmp = child[s][d1][si]; child[s][d1][si] = child[s][d2][sj]; child[s][d2][sj] = tmp;
      }
      newPop.push(child);
    }
    pop = newPop;
  }
  $('#progress').style.width='100%';
  $('#gaStatus').innerText = `GA Ø§Ù†ØªÙ‡Ù‰ â€” Ø£ÙØ¶Ù„: ${Math.round(bestScore)}`;
  return best;
}

/* ---------- exporting: PDF via html2canvas + jsPDF ---------- */
async function downloadPDF(){
  if(!lastSchedule){ alert('Ø£ÙˆÙ„Ø§Ù‹: Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ø«Ù… Ø­Ø§ÙˆÙ„ ØªÙ†Ø²ÙŠÙ„Ù‡ PDF.'); return; }
  const node = document.getElementById('output');
  $('#status').innerText = 'ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‰ PDF...';
  const canvas = await html2canvas(node, {scale:1.4, useCORS:true, backgroundColor:'#07182a'});
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'mm', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(img);
  const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
  pdf.addImage(img, 'PNG', 0, 0, pageWidth, pdfHeight);
  pdf.save('emploi_temps.pdf');
  $('#status').innerText = 'Ø§ÙƒØªÙ…Ù„ ØªÙ†Ø²ÙŠÙ„ PDF';
}

/* ---------- exporting Word (simple HTML -> .doc) ---------- */
function downloadWord(){
  if(!lastSchedule){ alert('Ø£ÙˆÙ„Ø§Ù‹: Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø¬Ø¯ÙˆÙ„ Ø«Ù… Ø­Ø§ÙˆÙ„ ØªÙ†Ø²ÙŠÙ„Ù‡ Word.'); return; }
  const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</title></head><body>`;
  const footer = `</body></html>`;
  const content = document.getElementById('output').innerHTML;
  const source = header + content + footer;
  const blob = new Blob(['\ufeff', source], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'emploi_temps.doc'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  $('#status').innerText = 'Ø§ÙƒØªÙ…Ù„ ØªÙ†Ø²ÙŠÙ„ Word (Ù…Ù„Ù .doc)';
}

/* ---------- helpers: reset/manual ---------- */
function resetForManual(){ state.teachers = []; renderTeachersTable(); $('#diagnostic').innerText = 'Ø£Ø¹Ø¯Øª Ø§Ù„ØªØ¹ÙŠÙŠÙ† â€” Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø«Ù… Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯'; $('#status').innerText='Ø£Ø¹Ø¯Øª Ø§Ù„ØªØ¹ÙŠÙŠÙ†'; }

</script>
</body>
</html>
