<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مولد مذكرات رياضيات (مذكرة كاملة)</title>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <!-- MathJax for equations -->
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>

  <style>
    :root{ --accent:#0b66a0; --paper:#ffffff; --bg:#eef4f8; }
    body{ font-family: "Tahoma", "Segoe UI", Arial; direction: rtl; background:var(--bg); padding:18px; }
    h1,h2,h3{ margin:0 0 8px 0; }
    .app{ max-width:1100px; margin:0 auto; display:flex; gap:18px; }
    .form { flex:1; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .previewWrap { width:750px; }
    label{ display:block; margin:8px 0 4px; font-weight:700; }
    input[type=text], textarea, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    textarea{ min-height:70px; }
    .btn { background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; margin-top:8px; }
    .lesson { border:1px dashed #cfe6f2; padding:8px; margin-bottom:10px; border-radius:6px; background:#fbfeff; }
    .controls-row { display:flex; gap:8px; }
    .small{ font-size:13px; color:#555; }

    /* --- PDF / page styles --- */
    #book { background:var(--paper); padding:18mm; color:#111; box-shadow:0 6px 18px rgba(0,0,0,0.16); }
    .cover { text-align:center; padding-top:30mm; padding-bottom:20mm; }
    .cover h1{ font-size:34px; color:var(--accent); }
    .cover .meta{ margin-top:20px; font-size:16px; }
    .toc { margin-top:8mm; margin-bottom:8mm; }
    .lessonPage { page-break-after: always; margin-bottom:6mm; }
    .lessonHeader { display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--accent); padding-bottom:6px; margin-bottom:8px; }
    .sectionBox { border-left:6px solid var(--accent); padding:8px; background:#fbfdff; margin-bottom:8px; }
    img.content-img{ max-width:100%; height:auto; border:1px solid #ddd; margin-top:6px; }

    /* Ensure page size for A4 when printing */
    @media print {
      body { background: white; }
      .app, .form, .btn { display:none; } /* hide UI when printing if using print */
      #book { box-shadow:none; width:210mm; min-height:297mm; padding:20mm; }
      .lessonPage { page-break-after: always; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="form">
    <h2>إعداد المذكرة (مذكرة كاملة)</h2>

    <label>اسم الأستاذ (سيظهر في الغلاف):</label>
    <input id="teacher" type="text" placeholder="اكتب اسمك هنا (مثلاً: د. علي بن محمد)" value="الأستاذ: د. مثال" />

    <label>اسم المؤسسة / سنة:</label>
    <input id="school" type="text" placeholder="مثلاً: مدرسة النور - السنة الدراسية 2025" value="متوسطة المثال — 2025" />

    <label>مستوى المذكرة:</label>
    <select id="level">
      <option>متوسط 1</option>
      <option>متوسط 2</option>
      <option>متوسط 3</option>
    </select>

    <hr />

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="addLesson" class="btn">+ إضافة درس جديد</button>
      <button id="clearAll" class="btn" style="background:#b33">مسح كل الدروس</button>
    </div>

    <div id="lessonsContainer" style="margin-top:12px; max-height:52vh; overflow:auto;"></div>

    <div style="margin-top:10px;">
      <button id="renderBtn" class="btn">عرض معاينة المذكرة</button>
      <button id="makePdfBtn" class="btn">تنزيل المذكرة كـ PDF</button>
      <div class="small" style="margin-top:6px;">ملاحظة: استخدم زر "إضافة درس" لإضافة أي عدد من الدروس. يدعم MathJax لكتابة المعادلات بين \\( ... \\) أو \\[ ... \\]</div>
    </div>
  </div>

  <div class="previewWrap">
    <h3>معاينة المذكرة (ستظهر هنا قبل التحويل)</h3>
    <div id="preview" style="display:block;">

      <!-- المكان الذي سيملأ به السكربت محتوى المذكرة -->
      <div id="book"></div>

    </div>
  </div>
</div>

<script>
  // Helpers
  const lessonsContainer = document.getElementById('lessonsContainer');
  const book = document.getElementById('book');
  let lessonCount = 0;

  function makeLessonForm(prefill = {}) {
    lessonCount++;
    const id = 'lesson_' + lessonCount;
    const el = document.createElement('div');
    el.className = 'lesson';
    el.id = id;
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>درس ${lessonCount}</strong>
        <div style="display:flex; gap:6px">
          <button class="btn btn-remove" style="background:#c33">حذف</button>
        </div>
      </div>

      <label>عنوان الدرس:</label>
      <input class="l-title" type="text" value="${prefill.title||''}" />

      <label>شرح الدرس (يمكن كتابة معادلات MathJax):</label>
      <textarea class="l-desc">${prefill.desc||''}</textarea>

      <label>أمثلة (ضع كل مثال بسطر):</label>
      <textarea class="l-ex">${prefill.examples||''}</textarea>

      <label>تمارين (ضع كل تمرين بسطر):</label>
      <textarea class="l-q">${prefill.exercises||''}</textarea>

      <label>حلول قصيرة (اختياري):</label>
      <textarea class="l-sol">${prefill.solutions||''}</textarea>

      <label>صورة توضيحية (اختياري):</label>
      <input type="file" accept="image/*" class="l-img" />
      <div class="small img-name"></div>
    `;

    lessonsContainer.appendChild(el);

    // remove handler
    el.querySelector('.btn-remove').addEventListener('click', ()=> {
      el.remove();
      rebuildPreview(); // refresh
    });

    // image load
    const imgInput = el.querySelector('.l-img');
    const imgNameDiv = el.querySelector('.img-name');
    imgInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      imgNameDiv.textContent = f.name;
      const reader = new FileReader();
      reader.onload = ()=> {
        el.dataset.img = reader.result;
      };
      reader.readAsDataURL(f);
    });

    // update preview on change
    el.querySelectorAll('input, textarea').forEach(inp=>{
      inp.addEventListener('input', () => rebuildPreview());
    });

    return el;
  }

  document.getElementById('addLesson').addEventListener('click', ()=> {
    makeLessonForm();
  });

  document.getElementById('clearAll').addEventListener('click', ()=> {
    lessonsContainer.innerHTML = '';
    lessonCount = 0;
    rebuildPreview();
  });

  function getAllLessons() {
    const nodes = Array.from(lessonsContainer.querySelectorAll('.lesson'));
    return nodes.map((node, i) => {
      return {
        title: node.querySelector('.l-title').value || `درس ${i+1}`,
        desc: node.querySelector('.l-desc').value || '',
        examples: node.querySelector('.l-ex').value || '',
        exercises: node.querySelector('.l-q').value || '',
        solutions: node.querySelector('.l-sol').value || '',
        image: node.dataset.img || null
      };
    });
  }

  function rebuildPreview() {
    const teacher = document.getElementById('teacher').value || '';
    const school = document.getElementById('school').value || '';
    const level = document.getElementById('level').value || '';
    const lessons = getAllLessons();

    // Build HTML for book
    let html = '';

    // Cover
    html += `<div class="cover lessonPage">
      <h1>مذكرة رياضيات</h1>
      <div style="margin-top:10px;font-size:20px;color:var(--accent)">${level}</div>
      <div class="meta" style="margin-top:18px">${school}</div>
      <div class="meta" style="margin-top:30px">الأستاذ: <strong>${teacher}</strong></div>
    </div>`;

    // Table of contents
    html += `<div class="toc lessonPage">
      <h2>فهرس المحتويات</h2>
      <ol>`;
    lessons.forEach((ls, idx) => {
      html += `<li>${ls.title || 'درس ' + (idx+1)}</li>`;
    });
    html += `</ol></div>`;

    // Lessons
    lessons.forEach((ls, idx) => {
      html += `<div class="lessonPage">
        <div class="lessonHeader">
          <div><h2>${idx+1}. ${ls.title}</h2></div>
          <div class="small">المستوى: ${level}</div>
        </div>

        <div class="sectionBox">
          <strong>الشرح:</strong>
          <div style="margin-top:6px">${nl2br(escapeHtml(ls.desc))}</div>
        </div>`;

      if(ls.image){
        html += `<div class="sectionBox">
          <strong>صورة توضيحية:</strong>
          <div><img class="content-img" src="${ls.image}" alt="صورة توضيحية" /></div>
        </div>`;
      }

      if(ls.examples.trim()){
        html += `<div class="sectionBox">
          <strong>أمثلة:</strong>
          <ol>`;
        ls.examples.split(/\n/).filter(s=>s.trim()).forEach(ex => {
          html += `<li>${escapeHtml(ex)}</li>`;
        });
        html += `</ol></div>`;
      }

      if(ls.exercises.trim()){
        html += `<div class="sectionBox">
          <strong>تمارين:</strong>
          <ol>`;
        ls.exercises.split(/\n/).filter(s=>s.trim()).forEach(q => {
          html += `<li>${escapeHtml(q)}</li>`;
        });
        html += `</ol></div>`;
      }

      if(ls.solutions.trim()){
        html += `<div class="sectionBox">
          <strong>حلول قصيرة:</strong>
          <div>${nl2br(escapeHtml(ls.solutions))}</div>
        </div>`;
      }

      html += `</div>`; // lessonPage
    });

    // Footer / credits
    html += `<div class="lessonPage" style="text-align:center;padding-top:80px;">
      <div class="small">تم إنشاؤها بواسطة مولد المذكرات — ${new Date().getFullYear()}</div>
    </div>`;

    book.innerHTML = html;

    // render math if any
    if(window.MathJax) MathJax.typesetPromise();
  }

  // utilities
  function nl2br(str){ return str.replace(/\n/g, '<br/>'); }
  function escapeHtml(text) {
    if(!text) return '';
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // initial
  makeLessonForm({ title: 'المستقيمات والتوازي', desc: 'تعريف المستقيم... \\(y=mx+c\\) مثال: \\(2x+3y=6\\).', examples: 'مثال 1: احسب ...\nمثال 2: اثبت ...', exercises: 'تمرين 1: ...\nتمرين 2: ...', solutions: 'حل 1: ...' });
  makeLessonForm({ title: 'الزوايا والمثلثات', desc: 'مفاهيم أساسية في الزوايا والمثلثات.', examples: 'مثال: مثلث قائم الزاوية...', exercises: 'تمرين: احسب قيمة ...', solutions: '' });
  rebuildPreview();

  document.getElementById('renderBtn').addEventListener('click', ()=> {
    rebuildPreview();
    // give MathJax time then scroll
    MathJax.typesetPromise().then(()=> {
      book.scrollIntoView({behavior:'smooth'});
    });
  });

  document.getElementById('makePdfBtn').addEventListener('click', ()=> {
    rebuildPreview();
    MathJax.typesetPromise().then(()=> {
      // options for html2pdf
      const opt = {
        margin:       [10,10,10,10],
        filename:     (document.getElementById('teacher').value || 'mouadara') + '.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      // clone book to avoid UI interference
      const element = book.cloneNode(true);
      // ensure fonts/background present
      element.style.background = 'white';
      // run converter
      html2pdf().set(opt).from(element).save();
    });
  });
</script>

</body>
</html>
